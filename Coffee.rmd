---
output:
  pdf_document: default
  html_document: default
---
# load the library
```{r}
library(tidyverse)
library(knitr)
library(dplyr)
# set wd
# setwd("~/Desktop/Github Projects/STA302")
```

# extract the subset of data we need
```{r}
coffee_df <- read.csv(file = "merged_data_cleaned.csv") %>% 
  rename("Ratings" = Total.Cup.Points) %>% 
  mutate(.before = 1, InSpecies = ifelse(Species == "Arabica", 1, 0)) %>% 
  select(Species, InSpecies, Aroma, Flavor, Aftertaste, Acidity, Sweetness, Ratings)
```

# numerical summary
```{r}
summary(coffee_df)

summary_table <- coffee_df %>%
  summarise(
    Aroma_mean = mean(Aroma),
    Flavor_mean = mean(Flavor),
    Aftertaste_mean = mean(Aftertaste),
    Sweetness_mean = mean(Sweetness),
    Acidity_mean = mean(Acidity),
    Aroma_sd = sd(Aroma),
    Flavor_sd = sd(Flavor),
    Aftertaste_sd = sd(Aftertaste),
    Sweetness_sd = sd(Sweetness),
    Acidity_sd = sd(Acidity),
    Aroma_max = max(Aroma),
    Flavor_max = max(Flavor),
    Aftertaste_max = max(Aftertaste),
    Sweetness_max = max(Sweetness),
    Acidity_max = max(Acidity),
    Aroma_min = min(Aroma),
    Flavor_min = min(Flavor),
    Aftertaste_min = min(Aftertaste),
    Sweetness_min = min(Sweetness),
    Acidity_min = min(Acidity), 
)

summary_frame = data.frame(
  Variables = c("Flavor", "Aroma", "Sweetness", "Aftertaste", "Acidity"),
  Min = c(summary_table$Flavor_min, summary_table$Aroma_min, summary_table$Sweetness_min, summary_table$Aftertaste_min, summary_table$Acidity_min),
  Max = c(summary_table$Flavor_max, summary_table$Aroma_max, summary_table$Sweetness_max, summary_table$Aftertaste_max, summary_table$Acidity_max),
  Mean = c(summary_table$Flavor_mean, summary_table$Aroma_mean, summary_table$Sweetness_mean, summary_table$Aftertaste_mean, summary_table$Acidity_mean),
  SD = c(summary_table$Flavor_sd, summary_table$Aroma_sd, summary_table$Sweetness_sd, summary_table$Aftertaste_sd, summary_table$Acidity_sd)
)

kable(summary_frame, format = "markdown", caption = "Coffee Ratings Dataset Numerical Summary", 
      col.names = c("Variable Name", "Minimum", "Maximum", "Mean", "Standard Deviation"), 
      align = "c", longtable = TRUE, digits = 3)

coffee_df %>% group_by(Species) %>% 
  summarise(num_species = n(),
            prop_species = n()/1339,
            mean_rating = mean(Ratings)) %>% 
  rename(`Number of Observations` = num_species, `Proportion` = prop_species, `Mean Rating` = mean_rating) %>% 
  kable(align = "c", longtable = TRUE, caption = "Coffee Ratings Dataset Categorical Variable Summary", digits = 3)
```
The coffee ratings dataset contains 1339 observations, with 1311 of these being of the "Arabica" species, while the other 28 are of the "Robusta" species. The minimum for all variables is 0, while the maximum rating is given in the Sweetness category. Sweetness also has the highest mean and standard deviation.  

# Fit the model
```{r}
model <- lm(Ratings ~ InSpecies + Aroma + Flavor + Aftertaste + Acidity + Sweetness, data = coffee_df)
model
```

# assumption checking
```{r}
# fitted values
y_hat <- fitted(model)
# residual
e_hat <- resid(model)

# attached these columns to coffee_df
coffee_df <- coffee_df %>% 
  mutate("y_hat" = fitted(model)) %>% 
  mutate("e_hat" = resid(model))


# write.csv(coffee_df, "CoffeeRatings.csv", row.names = FALSE)
```

# residual-fitted value plot
```{r}
# plot1 <- 
  ggplot(data = coffee_df, 
       mapping = aes(x = y_hat, y = e_hat))+
  geom_point(alpha = 0.5, size = 2)+ 
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))+
  labs(x = "Fitted", y = "Residuals", title = "Residual vs. Fitted")
# ggsave(plot1, file = "ResidFitted.png", dpi = 600, width = 5, height = 5)
```

# all residual vs. predictors
```{r}
par(mfrow = c(2, 3))

plot(x = coffee_df$InSpecies, y = e_hat,
                      main = "Residual vs. Species", xlab = "Species",
                      ylab = "Residual")
plot(x = coffee_df$Aroma, y = e_hat,
                    main = "Residual vs. Aroma", xlab = "Aroma",
                    ylab = "Residual")
plot(x = coffee_df$Flavor, y = e_hat,
                     main = "Residual vs. Flavor", xlab = "Flavor",
                     ylab = "Residual")
plot(x = coffee_df$Aftertaste, y = e_hat,
                    main = "Residual vs. Aftertaste", xlab = "Aftertaste",
                    ylab = "Residual")
plot(x = coffee_df$Acidity, y = e_hat,
                      main = "Residual vs. Acidity", xlab = "Acidity",
                      ylab = "Residual")
plot(x = coffee_df$Sweetness, y = e_hat,
                    main = "Residual vs. Sweetness", xlab = "Sweetness",
                    ylab = "Residual")

```
# checking normality of errors
```{r}

qqnorm(e_hat)
qqline(e_hat)
```
# Response vs. Fitted
```{r}
# plot3 <- 
  ggplot(data = coffee_df, 
                mapping = aes(x = y_hat, y = Ratings))+
  geom_point(alpha = 0.5, size = 2)+ 
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))+
  labs(x = "Fitted", y = "Ratings", title = "Response vs. Fitted")
# ggsave(plot3, file = "ResponseFitted.png", dpi = 600, width = 5, height = 5)
```
# pair plots of every predictors
```{r}
pairs(coffee_df[, c(2:7)])
```

